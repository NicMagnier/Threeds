var wiggle=new function(){this.speed=200;this.smooth=true;if(navigator.userAgent.indexOf("Nintendo 3DS")!=-1){this.smooth=false}this.play=false;this.showControls=false;this.init=function(){e=$(".wiggleFront");if(e.length>0){$("#wiggleControl").show();this.showControls=true}var a=document.cookie.split(";");var j="wiggleSpeed=";var b="wiggleSmooth=";for(var g=0;g<a.length;g++){var k=a[g];while(k.charAt(0)==" "){k=k.substring(1,k.length)}if(k.indexOf(j)==0){wiggle.setSpeed(k.substring(j.length,k.length));j=null}else{if(k.indexOf(b)==0){wiggle.setSmooth(k.substring(b.length,k.length));b=null}}}if(j!=null){wiggle.setSpeed(this.speed)}if(b!=null){wiggle.setSmooth(this.smooth)}};this.start=function(){if(wiggle.play){return}wiggle.play=true;wiggle.update()};this.stop=function(){wiggle.play=false};this.update=function(){if(!wiggle.play){return}e=$(".wiggleFront");f=$(e).first();if(f.hasClass("_hide")){e.show();if(wiggle.smooth){e.animate({opacity:1},wiggle.speed*0.7)}else{e.css({opacity:1})}f.removeClass("_hide")}else{if(wiggle.smooth){e.animate({opacity:0},wiggle.speed*0.7)}else{e.css({opacity:1});e.hide()}f.addClass("_hide")}setTimeout("wiggle.update();",wiggle.speed)};this.setSpeed=function(b){wiggle.speed=b;if(b==0){wiggle.stop()}else{wiggle.start()}var a=new Date();a.setTime(a.getTime()+(365*24*60*60*1000));document.cookie="wiggleSpeed="+b+"; expires="+a.toGMTString()+"; path=/";wc=$("#wiggleControl");$(".wcSpeed",wc).removeClass("wcSpeedSelected");$(".wcSpeed"+b,wc).addClass("wcSpeedSelected")};this.setSmooth=function(a){if(a==true||a=="true"){a=true}else{a=false}wiggle.smooth=a;var c=new Date();c.setTime(c.getTime()+(365*24*60*60*1000));document.cookie="wiggleSmooth="+a+"; expires="+c.toGMTString()+"; path=/";wc=$("#wiggleControl");$(".wcSmooth",wc).prop("checked",a)}};$(document).ready(function(){$(".psub").mousedown(function(){return false});$(".padd").mousedown(function(){return false});$(".psub").on("click",function(b){var a=$(this).next();$(a).val($(a).val()-1);$(a).trigger("change")});$(".padd").on("click",function(b){var a=$(this).prev();$(a).val(parseInt($(a).val(),10)+1);$(a).trigger("change")});$(".menuSave").click(function(){var a=$(".saving",this);if(a.is(":visible")){return}saveImage(a);$(this).children().hide();$(a).show()}).hide().children().hide();$(".menuSave .save").show();if(navigator.userAgent.indexOf("Nintendo 3DS")!=-1){evt="focus"}else{evt="change keyup"}$(".description textarea").on(evt,function(){setSaveDirty(this)})});$(document).on("change keyup","input.parallax",function(){var a=parseInt($(this).val());if(isNaN(a)){return}imgSetParallax($(this).parents(".postContainter").find(".wiggleContainer"),pixel2ratio(a))});function ratio2pixel(a){return parseInt((a-1)*-640)}function pixel2ratio(a){return(640-a)/640}function imgWiggle(b,a){if(b.tagName=="IMG"){url=b.src}else{console.log(b)}width=$(b).width();height=$(b).height();width/=2;if(navigator.userAgent.indexOf("Nintendo 3DS")!=-1&&$(b).hasClass("scaleFor3DS")){width/=2;height/=2}container=$("<div/>",{width:width}).addClass("wiggleContainer").hide();backDiv=$("<div/>",{height:height,}).css({"background-image":"url("+url+")","background-size":(width*2)+"px "+height+"px"}).addClass("wiggleBack").appendTo(container);frontDiv=$("<div/>",{height:height,}).css({"background-image":"url("+url+")","background-size":(width*2)+"px "+height+"px"}).addClass("wiggleFront").appendTo(container);eventDiv=$("<div/>",{height:height,}).addClass("wiggleEvent").appendTo(container);$(b).after(container);container.data("width",width);container.data("height",height);container.data("parallax",a);imgUpdate(container);$(container).parents(".postContainter").find("input.parallax").val(ratio2pixel(a));$(b).hide();$(container).show();$("body").removeClass("noWiggleScript")}function imgSetParallax(b,a){if(a==0){}b.data("parallax",a);setSaveDirty(b);imgUpdate(b)}function imgUpdate(a){w=a.data("width");h=a.data("height");p=a.data("parallax");if(w==0){getWidthAgain(a.prev());return}$(a).height(h);cw=w*p;if(p<1){$(a).width(cw);$(".wiggleBack",a).width(cw).css({"background-position":"left top",left:"0"});$(".wiggleFront",a).width(cw).css({"background-position":"right top",right:"0"})}else{mw=w*(p-1);$(a).width(cw);$(".wiggleBack",a).width(cw-(mw*2)).css({"background-position":"-"+mw+"px 0px",left:mw+"px"});$(".wiggleFront",a).width(cw-(mw*2)).css({"background-position":"-"+w+"px 0px",right:mw+"px"})}}function getWidthAgain(a){$("<img/>").attr("src",$(a).attr("src")).data("cid",$(a).parent().attr("id")).load(function(){var i=$(this).data("cid");var g=$("#"+i+".jps").find(".wiggleContainer");var b=this.width;if(this.src.slice(-3).toLowerCase()=="jps"){b=Math.round(b/2)}$(g).data("width",b);$(g).data("height",this.height);imgUpdate(g)})}function pfocus(g,k,c){var b=$(k).attr("id");if(typeof g.offsetX==="undefined"||typeof g.offsetY==="undefined"){var j=$(g.target).offset();var a=g.pageX-j.left;var i=g.pageY-j.top}else{var a=g.offsetX;var i=g.offsetY}$("<img/>").attr("src",$(LoadAnimation).attr("src")).addClass("loadanim").css({position:"absolute",top:(i-8)+"px",left:(a-8)+"px",}).appendTo(k);
imgw=$("img",k).width()/2;imgh=$("img",k).height();a+=imgw-$(k).width();a/=imgw;i/=imgh;$.ajax({url:"ajax.focus",type:"POST",data:"gid="+c+"&hid="+b+"&x="+a+"&y="+i,dataType:"json",success:function(l){animPF(l.hid,l.parallax)}})}function animPF(a,b){e=$(".wiggleContainer","#"+a);e.data("target",b);par=e.data("parallax");if(b==par){$(".loadanim","#"+a).remove();return}s=(b-par)/20;e.data("step",s);updatePF(a)}function updatePF(a){e=$(".wiggleContainer","#"+a);tar=e.data("target");stp=e.data("step");par=e.data("parallax");d=tar-par;if(stp*stp>d*d){imgSetParallax(e,tar);e.removeData("target");e.removeData("step");$(".loadanim","#"+a).remove();return}imgSetParallax(e,par+stp);$(e).parents(".postContainter").find("input.parallax").val(ratio2pixel(p));setTimeout("updatePF('"+a+"');",33)}function setSaveDirty(b){var a=$(b).parents(".postContainter").find(".menuSave");a.addClass("dirty");a.show(300)}function saveImage(g){g=$(g).parents(".postContainter");var a=g.attr("id");var c=$(".wiggleContainer",g).data("parallax");var i=encodeURIComponent($(".description textarea",g).val());var b=$.ajax({url:"ajax.save",type:"POST",data:"gid="+a+"&parallax="+c+"&description="+i,dataType:"json",});b.done(function(j){var k=$("#"+j.gid+" .menuSave");k.removeClass("dirty");$(".saving",k).hide().siblings(".saved").show();setTimeout('closeSave("'+j.gid+'")',2000)});b.fail(function(j,k){console.log("Request failed: "+k)})}function closeSave(a){var b=$("#"+a+" .menuSave");if($(".saving",b).is(":visible")){return}b.children().hide();$(".save",b).show();if(b.hasClass("dirty")){return}b.hide(300)};